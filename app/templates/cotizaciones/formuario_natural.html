{% extends "base.html" %}
{% block title %}Cotización Personal{% endblock %}

{% block content %}
<div class="p-8">
    <div class="mb-6 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-900">Nueva Cotización Personal</h1>
        <a href="{{ url_for('select_type') }}" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">
            <i class="fas fa-arrow-left"></i> Volver
        </a>
    </div>

    <div class="bg-white rounded-lg shadow-md p-6">
        <form action="{{ url_for('generate_pdf_natural') }}" method="POST" class="space-y-6">
            <!-- Información del cliente -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nombre del Cliente</label>
                    <input type="text" name="nombre" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Ubicación</label>
                    <input type="text" name="ubicacion" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Teléfono</label>
                    <input type="text" name="telefono" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Correo</label>
                    <input type="email" name="correo"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
            </div>

            <!-- ITBMS Toggle -->
            <div class="flex items-center">
                <label class="flex items-center">
                    <input type="checkbox" name="itbms" class="rounded text-indigo-600">
                    <span class="ml-2 text-sm text-gray-700">Incluir ITBMS</span>
                </label>
            </div>

            <!-- Items Table -->
            <div class="mt-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Items</h3>
                    <button type="button" onclick="agregarItem()" 
                            class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                        <i class="fas fa-plus"></i> Agregar Item
                    </button>
                </div>
                
                <div id="items-container" class="space-y-4">
                    <!-- Items will be added here dynamically -->
                </div>
            </div>

            <!-- Totals -->
            <div class="mt-6 flex justify-end">
                <div class="w-64 space-y-2">
                    <div class="flex justify-between">
                        <span class="font-medium">Subtotal:</span>
                        <span id="subtotal">$0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-medium">ITBMS (7%):</span>
                        <span id="itbms">$0.00</span>
                    </div>
                    <div class="flex justify-between text-lg font-bold">
                        <span>Total:</span>
                        <span id="total">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="mt-6 flex justify-end space-x-4">
                <button type="button" onclick="window.location.href='{{ url_for('select_type') }}'"
                        class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">
                    Cancelar
                </button>
                <button type="submit"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                    Generar Cotización
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function agregarItem() {
    const container = document.getElementById('items-container');
    const itemIndex = container.children.length;
    
    const itemDiv = document.createElement('div');
    itemDiv.className = 'grid grid-cols-12 gap-4 items-center';
    itemDiv.innerHTML = `
        <div class="col-span-5">
            <input type="text" name="descripcion[]" placeholder="Descripción" required
                   class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
        </div>
        <div class="col-span-2">
            <input type="number" name="precio_unitario[]" placeholder="Precio" step="0.01" required
                   onchange="calcularTotal(${itemIndex})"
                   class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
        </div>
        <div class="col-span-2">
            <input type="number" name="unidades[]" placeholder="Cantidad" required
                   onchange="calcularTotal(${itemIndex})"
                   class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
        </div>
        <div class="col-span-2">
            <input type="text" name="total[]" readonly
                   class="block w-full rounded-md border-gray-300 bg-gray-50">
        </div>
        <div class="col-span-1">
            <button type="button" onclick="this.parentElement.parentElement.remove(); actualizarTotales()"
                    class="text-red-600 hover:text-red-800">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    container.appendChild(itemDiv);
}

function calcularTotal(index) {
    const container = document.getElementById('items-container');
    const item = container.children[index];
    const precio = parseFloat(item.querySelector('[name="precio_unitario[]"]').value) || 0;
    const cantidad = parseInt(item.querySelector('[name="unidades[]"]').value) || 0;
    const total = precio * cantidad;
    item.querySelector('[name="total[]"]').value = total.toFixed(2);
    actualizarTotales();
}

function actualizarTotales() {
    const totales = Array.from(document.getElementsByName('total[]'))
        .map(input => parseFloat(input.value) || 0);
    const subtotal = totales.reduce((a, b) => a + b, 0);
    const itbms = document.querySelector('[name="itbms"]').checked ? subtotal * 0.07 : 0;
    const total = subtotal + itbms;
    
    document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('itbms').textContent = `$${itbms.toFixed(2)}`;
    document.getElementById('total').textContent = `$${total.toFixed(2)}`;
}

// Agregar primer item automáticamente
document.addEventListener('DOMContentLoaded', function() {
    agregarItem();
});
</script>
{% endblock %}